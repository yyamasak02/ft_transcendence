name: build_check

on: [pull_request]

jobs:
  docker:
    name: Docker Compose Build & Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      # Provide the gist page URL via a single variable
      # Use either: secrets.SECRET_GIST or vars.SECRET_GIST
      SECRET_GIST: ${{ secrets.SECRET_GIST || vars.SECRET_GIST }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker info
        run: |
          docker --version
          docker compose version
          df -h

      - name: Prepare secret.yaml
        run: |
          set -euo pipefail
          if [[ -z "${SECRET_GIST:-}" ]]; then
            echo "SECRET_GIST is required. Define it as a repository secret or variable." >&2
            exit 1
          fi
          raw="$SECRET_GIST"
          raw="${raw/gist.github.com/gist.githubusercontent.com}"
          case "$raw" in
            */raw* ) : ;;
            * ) raw="${raw%/}/raw" ;;
          esac
          echo "Fetching secret from $raw"
          curl -fsSL "$raw" -o secret.yaml
          echo "secret.yaml prepared:" && ls -l secret.yaml

      - name: make init (compose up)
        run: |
          make init

      - name: HTTP health checks
        run: |
          set -euxo pipefail
          urls=(
            "http://localhost:8080/api/docs/"
            "http://localhost:8083/api/docs/"
          )
          for url in "${urls[@]}"; do
            echo "Checking $url"
            ok=false
            for i in {1..60}; do
              if curl -fLsS "$url" >/dev/null 2>&1; then
                ok=true
                break
              fi
              sleep 3
            done
            if [ "$ok" != true ]; then
              echo "Health check failed for $url" >&2
              exit 1
            fi
          done

      - name: Check Container Health Status
        run: |
          echo "Waiting for containers to stabilize..."
          success=false
          for i in {1..10}; do
            STATUS=$(docker compose -f docker-compose.local.yml ps | grep -E 'Exit|restarting' || true)
            if [ -z "$STATUS" ]; then
              echo "âœ… All required services are running smoothly."
              docker compose -f docker-compose.local.yml ps
              success=true
              break
            fi
            echo "Retrying... ($i/10)"
            sleep 5
          done

          if [ "$success" = false ]; then
            echo "--- ERROR: Some containers failed to start ---"
            docker compose -f docker-compose.local.yml ps
            exit 1
          fi

      - name: Debug containers
        if: failure()
        run: |
          echo "=== Container status ==="
          docker compose -f docker-compose.local.yml ps -a
          echo
          echo "=== Logs from containers ==="
          docker compose -f docker-compose.local.yml logs --no-color --tail=200 || true

      - name: Cleanup containers
        if: always()
        run: docker compose -f docker-compose.local.yml down

      - name: Cleanup secret.yaml
        if: always()
        run: rm -f secret.yaml || true
