<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Login Test</title>
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
    ></script>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        max-width: 720px;
        margin: 2rem auto;
        padding: 0 1rem 3rem;
      }
      label {
        display: block;
        margin: 0.5rem 0 0.25rem;
        font-weight: 600;
      }
      input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        box-sizing: border-box;
      }
      .row {
        margin: 0.5rem 0 1rem;
      }
      button {
        padding: 0.6rem 1rem;
        font-size: 1rem;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 0.75rem;
        white-space: pre-wrap;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <h1>Google Login Test</h1>
    <p>Google ID トークンを取得し、そのままバックエンドの <code>/user/google_login</code> に送るシンプルな検証ページです。</p>

    <label for="client-id">Google Client ID</label>
    <input id="client-id" type="text" placeholder="xxxxxxxx.apps.googleusercontent.com" />

    <label for="api-base">API Base URL</label>
    <input id="api-base" type="text" value="/api/common" />

    <div class="row">
      <label>
        <input id="long-term" type="checkbox" checked />
        longTerm トークンを要求する
      </label>
    </div>

    <div class="row">
      <button id="init-btn">Google ボタンを初期化</button>
    </div>

    <div id="gsi-btn"></div>

    <h2>ログ</h2>
    <pre id="log"></pre>

    <script>
      const clientIdInput = document.getElementById("client-id");
      const apiBaseInput = document.getElementById("api-base");
      const longTermCheckbox = document.getElementById("long-term");
      const logEl = document.getElementById("log");
      const gsiBtnContainer = document.getElementById("gsi-btn");

      const savedClientId = localStorage.getItem("google_client_id");
      if (savedClientId) {
        clientIdInput.value = savedClientId;
      }

      function log(message) {
        const time = new Date().toISOString();
        logEl.textContent += `[${time}] ${message}\n`;
      }

      async function handleCredentialResponse({ credential }) {
        if (!credential) {
          log("credential が空です。");
          return;
        }

        const apiBase = apiBaseInput.value.replace(/\/$/, "");
        const longTerm = longTermCheckbox.checked;

        log("ID トークンをバックエンドへ送信中...");
        try {
          const res = await fetch(`${apiBase}/user/google_login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken: credential, longTerm }),
          });
          const json = await res.json();
          log(`status: ${res.status}`);
          log(JSON.stringify(json, null, 2));
        } catch (error) {
          log(`fetch エラー: ${error}`);
        }
      }

      function initGsi() {
        if (!window.google || !google.accounts || !google.accounts.id) {
          log("Google Identity Services がまだ読み込まれていません。");
          return;
        }

        const clientId = clientIdInput.value.trim();
        if (!clientId) {
          alert("Google Client ID を入力してください。");
          return;
        }

        localStorage.setItem("google_client_id", clientId);
        gsiBtnContainer.innerHTML = "";

        google.accounts.id.initialize({
          client_id: clientId,
          callback: handleCredentialResponse,
        });
        google.accounts.id.renderButton(gsiBtnContainer, {
          theme: "outline",
          size: "large",
          type: "standard",
          text: "continue_with",
        });
        google.accounts.id.prompt();
        log("Google ボタンを初期化しました。");
      }

      document
        .getElementById("init-btn")
        .addEventListener("click", initGsi);
    </script>
  </body>
</html>
